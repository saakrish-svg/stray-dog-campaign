<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêï Stop Stray Dog Issues - Sign Now!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(45deg, #ff4757, #ff3742);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .content {
            padding: 20px;
        }

        .problem-box {
            background: #ffe6e6;
            border-left: 4px solid #ff4757;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .problem-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            font-size: 14px;
        }

        .problem-item span {
            margin-right: 8px;
            font-size: 16px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn-sign {
            width: 100%;
            background: #27ae60;
            color: white;
            padding: 15px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
        }

        .btn-sign:hover {
            background: #219a52;
        }

        .btn-sign:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .signatures {
            background: #e8f5e8;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
        }

        .signature-count {
            font-size: 2rem;
            font-weight: bold;
            color: #27ae60;
        }

        .signature-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
            text-align: left;
        }

        .signature-item {
            background: white;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 12px;
            border-left: 3px solid #27ae60;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .share-section {
            background: #e3f2fd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
        }

        .btn-share {
            background: #25d366;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            margin: 5px;
            cursor: pointer;
        }

        .btn-report {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            margin: 5px;
            cursor: pointer;
        }

        .progress-bar {
            background: #ddd;
            height: 8px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .progress-fill {
            background: #27ae60;
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .footer {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 12px;
        }

        .success-message, .error-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            background: #fff3cd;
            border-radius: 5px;
            margin: 10px 0;
        }

        .status-indicator {
            background: #d1ecf1;
            color: #0c5460;
            padding: 8px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 11px;
            text-align: center;
        }

        .status-indicator.online {
            background: #d4edda;
            color: #155724;
        }

        .status-indicator.error {
            background: #f8d7da;
            color: #721c24;
        }

        .admin-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            display: none;
        }

        .admin-login input {
            width: 70%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 5px;
        }

        .admin-login button {
            width: 25%;
            background: #e67e22;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .admin-panel {
            background: #e8f5e8;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
            display: none;
        }

        .test-buttons {
            margin: 10px 0;
        }

        .test-buttons button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 11px;
            margin: 2px;
            cursor: pointer;
        }

        .duplicate-prevention {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üö® URGENT: Stray Dog Crisis</h1>
            <p>Help Make Our Apartment Safe Again!</p>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Status Indicator -->
            <div class="status-indicator" id="statusIndicator">
                üîÑ Connecting to database...
            </div>

            <div class="problem-box">
                <h3 style="color: #c0392b; margin-bottom: 10px;">Problems We're Facing:</h3>
                <div class="problem-item">
                    <span>ü©∏</span>
                    <div>Dog fights leaving blood stains in corridors</div>
                </div>
                <div class="problem-item">
                    <span>üöó</span>
                    <div>Scratched cars and damaged property</div>
                </div>
                <div class="problem-item">
                    <span>ü¶†</span>
                    <div>Unhygienic conditions and waste everywhere</div>
                </div>
                <div class="problem-item">
                    <span>üò∞</span>
                    <div>Children and elderly feeling unsafe</div>
                </div>
                <div class="problem-item">
                    <span>üè†</span>
                    <div>Property value declining</div>
                </div>
            </div>

            <!-- Messages -->
            <div class="success-message" id="successMessage">
                ‚úÖ Thank you for signing! Your signature has been saved successfully.
            </div>

            <div class="error-message" id="errorMessage">
                ‚ùå You have already signed this petition. Each person can only sign once.
            </div>

            <div class="loading" id="loadingMessage">
                üíæ Saving your signature...
            </div>

            <!-- Duplicate Prevention Notice -->
            <div class="duplicate-prevention">
                üîí <strong>Duplicate Protection:</strong> Only one signature per person allowed. System checks for duplicate row/flat numbers and mobile numbers.
            </div>

            <!-- Signature Form -->
            <div class="form-section" id="signatureForm">
                <h3 style="margin-bottom: 10px;">üìù Sign the Petition</h3>
                
                <form id="petitionForm">
                    <div class="form-group">
                        <label>Full Name*</label>
                        <input type="text" name="fullName" id="fullName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label>Row, Column & Flat Number*</label>
                        <input type="text" name="flatNumber" id="flatNumber" placeholder="e.g., R11 C - 401 or B-205" required>
                        <small style="color: #666; font-size: 11px; margin-top: 3px; display: block;">
                            Include Row (R), Column (C) if applicable, and flat number
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Mobile Number*</label>
                        <input type="tel" name="mobile" id="mobile" placeholder="Enter mobile number" required>
                    </div>
                    <div class="form-group">
                        <label>Your Main Concern</label>
                        <select name="concern" id="concern">
                            <option value="">Select primary concern</option>
                            <option value="safety">Safety of family members</option>
                            <option value="property">Property damage</option>
                            <option value="hygiene">Cleanliness and hygiene</option>
                            <option value="noise">Noise and disturbance</option>
                            <option value="all">All of the above</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn-sign" id="signButton">‚úçÔ∏è SIGN PETITION NOW</button>
                </form>
            </div>

            <!-- Current Signatures Display -->
            <div class="signatures">
                <div class="signature-count" id="signatureCount">0</div>
                <div style="font-size: 14px; color: #666;">Residents Have Signed</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div style="font-size: 12px; margin-top: 5px;">Target: 50 signatures</div>
                
                <div class="signature-list" id="signatureList">
                    <div style="text-align: center; color: #666; font-size: 12px; padding: 10px;">
                        Loading signatures...
                    </div>
                </div>
                
                <div style="margin-top: 10px;">
                    <button onclick="refreshData()" class="btn-report" style="font-size: 11px; padding: 5px 10px;">
                        üîÑ Refresh Live Data
                    </button>
                </div>
            </div>

            <!-- Share Section -->
            <div class="share-section">
                <h4>üì¢ Spread the Word!</h4>
                <button class="btn-share" onclick="shareOnWhatsApp()">üì± Share on WhatsApp</button>
                <button class="btn-report" onclick="showAdminLogin()">üîê Admin Panel</button>
            </div>

            <!-- Admin Section -->
            <div class="admin-section" id="adminSection">
                <h4>üîê Admin Access Required</h4>
                <p style="font-size: 12px; color: #666;">Enter admin password to manage signatures.</p>
                <div class="admin-login">
                    <input type="password" id="adminPassword" placeholder="Admin Password">
                    <button onclick="loginAdmin()">Login</button>
                </div>
            </div>

            <!-- Admin Panel -->
            <div class="admin-panel" id="adminPanel">
                <h4>üëë Admin Panel</h4>
                <div style="margin: 10px 0; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 12px;" id="adminStats">
                    <strong>Loading admin statistics...</strong>
                </div>
                
                <div class="test-buttons">
                    <button onclick="testConnection()">Test Connection</button>
                    <button onclick="addTestData()" style="background: #28a745;">Add Test Data</button>
                    <button onclick="viewRules()" style="background: #ffc107; color: black;">Database Info</button>
                </div>
                
                <button class="btn-report" onclick="viewAllSignatures()">üìä View All Signatures</button>
                <button class="btn-report" onclick="exportData()">üìã Export Data</button>
                <button class="btn-report" onclick="resetAllData()" style="background: #e74c3c;">üóëÔ∏è Reset All</button>
                <button class="btn-share" onclick="logoutAdmin()" style="background: #95a5a6;">üö™ Logout</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Together we can make our apartment safe and clean! üè°</p>
            <p style="margin-top: 5px; font-size: 10px;">Powered by Firebase Firestore</p>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules - EXACTLY LIKE YOUR WORKING TEST
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            serverTimestamp, 
            query, 
            orderBy, 
            limit,
            where,
            deleteDoc,
            doc
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // Firebase Configuration - YOUR WORKING SETTINGS
        const firebaseConfig = {
            apiKey: "AIzaSyAh4DeMpppqfI9ufPDGQA92T3nD24jurk8",
            authDomain: "stray-dog-petition.firebaseapp.com",
            projectId: "stray-dog-petition",
            storageBucket: "stray-dog-petition.firebasestorage.app",
            messagingSenderId: "727804804946",
            appId: "1:727804804946:web:106cf6fc25051bf3edc48b",
            measurementId: "G-9F0LW6LEL7"
        };

        // Global Variables
        const TARGET_SIGNATURES = 50;
        const ADMIN_PASSWORD = "StrayDog2025";
        let db = null;
        let isConnected = false;

        // Initialize Firebase - USING YOUR WORKING PATTERN
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);

        console.log('üöÄ Stray Dog Petition Campaign - Starting Application');
        console.log('‚úÖ Firebase initialized successfully');
        updateStatus('‚úÖ Connected to Firestore database', 'online');
        isConnected = true;

        // ===========================================
        // UTILITY FUNCTIONS
        // ===========================================
        
        function updateStatus(message, type) {
            const statusEl = document.getElementById('statusIndicator');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = 'status-indicator ' + (type || '');
            }
            console.log('Status: ' + message);
        }

        function showMessage(elementId, show) {
            const el = document.getElementById(elementId);
            if (el) {
                el.style.display = show ? 'block' : 'none';
            }
        }

        function hideAllMessages() {
            showMessage('successMessage', false);
            showMessage('errorMessage', false);
            showMessage('loadingMessage', false);
        }

        // ===========================================
        // FIRESTORE DATABASE FUNCTIONS
        // ===========================================

        async function loadSignatures() {
            try {
                console.log('üîÑ Loading signatures from Firestore...');
                
                const signaturesRef = collection(db, 'signatures');
                const q = query(signaturesRef, orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                
                const signatures = [];
                querySnapshot.forEach((doc) => {
                    signatures.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log(`üìä Loaded ${signatures.length} signatures`);
                updateSignatureCount(signatures.length, signatures);
                
            } catch (error) {
                console.error('‚ùå Error loading signatures:', error);
                updateStatus('‚ùå Error loading signatures: ' + error.message, 'error');
            }
        }

        async function checkForDuplicates(flat, mobile) {
            try {
                console.log(`üîç Checking for duplicates - Flat: ${flat}, Mobile: ${mobile}`);
                
                const signaturesRef = collection(db, 'signatures');
                
                // Check for duplicate flat
                const flatQuery = query(signaturesRef, where('flat', '==', flat));
                const flatSnapshot = await getDocs(flatQuery);
                
                // Check for duplicate mobile
                const mobileQuery = query(signaturesRef, where('mobile', '==', mobile));
                const mobileSnapshot = await getDocs(mobileQuery);
                
                const duplicateFlat = !flatSnapshot.empty;
                const duplicateMobile = !mobileSnapshot.empty;
                
                console.log(`üîç Duplicate check: Flat=${duplicateFlat}, Mobile=${duplicateMobile}`);
                
                return {
                    isDuplicate: duplicateFlat || duplicateMobile,
                    duplicateFlat,
                    duplicateMobile
                };
                
            } catch (error) {
                console.error('‚ùå Error checking duplicates:', error);
                return { isDuplicate: false, error: error.message };
            }
        }

        async function saveSignature(signatureData) {
            try {
                console.log('üíæ Saving signature to Firestore...');
                
                const docRef = await addDoc(collection(db, 'signatures'), {
                    ...signatureData,
                    createdAt: serverTimestamp()
                });
                
                console.log('‚úÖ Signature saved with ID:', docRef.id);
                return docRef.id;
                
            } catch (error) {
                console.error('‚ùå Error saving signature:', error);
                throw error;
            }
        }

        function updateSignatureCount(count, signatures) {
            // Update count display
            const countEl = document.getElementById('signatureCount');
            if (countEl) {
                countEl.textContent = count || 0;
            }
            
            // Update progress bar
            const progress = Math.min((count / TARGET_SIGNATURES) * 100, 100);
            const progressEl = document.getElementById('progressFill');
            if (progressEl) {
                progressEl.style.width = progress + '%';
            }
            
            // Update signature list
            const listEl = document.getElementById('signatureList');
            if (listEl) {
                listEl.innerHTML = '';
                
                if (signatures && signatures.length > 0) {
                    signatures.slice(0, 5).forEach((sig, index) => {
                        const item = document.createElement('div');
                        item.className = 'signature-item';
                        item.innerHTML = 
                            `<div><strong>Resident #${count - index}</strong><br>` +
                            `<small>Flat ${sig.flat || 'Unknown'}</small></div>` +
                            `<div style="font-size: 10px; color: #666;">` + 
                            `${sig.time ? new Date(sig.time).toLocaleDateString() : 'Recently'}` + 
                            `</div>`;
                        listEl.appendChild(item);
                    });
                    
                    if (signatures.length > 5) {
                        const moreEl = document.createElement('div');
                        moreEl.style.cssText = 'text-align: center; color: #666; font-size: 11px; padding: 5px;';
                        moreEl.textContent = `...and ${signatures.length - 5} more residents`;
                        listEl.appendChild(moreEl);
                    }
                } else {
                    listEl.innerHTML = '<div style="text-align: center; color: #666; font-size: 12px; padding: 10px;">No signatures yet - be the first to sign! üèÜ</div>';
                }
            }
            
            console.log(`üìä Updated display: ${count} signatures`);
        }

        // ===========================================
        // FORM HANDLING
        // ===========================================
        
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            hideAllMessages();
            
            if (!isConnected) {
                alert('‚ùå Database not connected! Please check your internet connection.');
                return;
            }
            
            // Get form data
            const formData = new FormData(event.target);
            const signature = {
                name: formData.get('fullName').trim(),
                flat: formData.get('flatNumber').trim().toUpperCase(),
                mobile: formData.get('mobile').trim(),
                concern: formData.get('concern') || 'Not specified',
                timestamp: new Date().toISOString(),
                time: new Date().toLocaleString()
            };
            
            console.log('üìù Form submitted:', signature);
            
            // Validate
            if (!signature.name || !signature.flat || !signature.mobile) {
                alert('‚ö†Ô∏è Please fill in all required fields!');
                return;
            }
            
            if (signature.mobile.length < 10) {
                alert('‚ö†Ô∏è Please enter a valid mobile number (minimum 10 digits)!');
                return;
            }
            
            // Show loading
            showMessage('loadingMessage', true);
            const signButton = document.getElementById('signButton');
            if (signButton) {
                signButton.disabled = true;
                signButton.textContent = 'Checking duplicates...';
            }
            
            try {
                // Check duplicates
                const duplicateCheck = await checkForDuplicates(signature.flat, signature.mobile);
                
                if (duplicateCheck.isDuplicate) {
                    let errorMsg = '‚ùå Duplicate signature detected!\n\n';
                    if (duplicateCheck.duplicateFlat) errorMsg += `‚Ä¢ Flat ${signature.flat} has already signed\n`;
                    if (duplicateCheck.duplicateMobile) errorMsg += `‚Ä¢ Mobile number already used\n`;
                    errorMsg += '\nEach resident can only sign once.';
                    
                    alert(errorMsg);
                    
                    showMessage('loadingMessage', false);
                    if (signButton) {
                        signButton.disabled = false;
                        signButton.textContent = '‚úçÔ∏è SIGN PETITION NOW';
                    }
                    return;
                }
                
                // Save signature
                if (signButton) {
                    signButton.textContent = 'Saving to database...';
                }
                
                const signatureId = await saveSignature(signature);
                
                console.log('‚úÖ Signature process completed successfully');
                
                // Hide form and loading
                showMessage('loadingMessage', false);
                showMessage('successMessage', true);
                showMessage('signatureForm', false);
                
                // Mark as signed locally
                localStorage.setItem('hasSignedPetition', 'true');
                localStorage.setItem('signedFlat', signature.flat);
                localStorage.setItem('signedAt', signature.timestamp);
                
                // Reload signatures to show updated count
                await loadSignatures();
                
            } catch (error) {
                console.error('‚ùå Error in signature process:', error);
                
                showMessage('loadingMessage', false);
                if (signButton) {
                    signButton.disabled = false;
                    signButton.textContent = '‚úçÔ∏è SIGN PETITION NOW';
                }
                
                alert(`‚ùå Error saving signature: ${error.message}\n\nPlease try again.`);
            }
        }

        // ===========================================
        // UI FUNCTIONS
        // ===========================================
        
        function shareOnWhatsApp() {
            const countEl = document.getElementById('signatureCount');
            const count = countEl ? parseInt(countEl.textContent) || 0 : 0;
            const progress = Math.round((count / TARGET_SIGNATURES) * 100);
            const url = window.location.href;
            
            const message = `üö® URGENT: Stray Dog Crisis Petition!\n\n` +
                `üìä LIVE COUNT: ${count}/${TARGET_SIGNATURES} signatures (${progress}%)\n` +
                `üåê Real-time shared database\n` +
                `üéØ Help us reach our goal!\n\n` +
                `Problems:\n` +
                `ü©∏ Dog fights with blood stains\n` +
                `üöó Property damage\n` +
                `ü¶† Unhygienic conditions\n` +
                `üò∞ Safety concerns\n\n` +
                `Sign now: ${url}\n\n` +
                `‚ö†Ô∏è Only one signature per flat/mobile\n` +
                `‚ö° Live updates for all group members\n` +
                `üîí Secure database\n` +
                `Takes 30 seconds! üôè\n\n` +
                `#SafeApartment #RealTimeDatabase`;
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        async function refreshData() {
            if (!isConnected) {
                alert('‚ö†Ô∏è Database not connected! Cannot refresh data.');
                return;
            }
            
            console.log('üîÑ Manual refresh requested');
            updateStatus('üîÑ Refreshing data...', '');
            
            await loadSignatures();
            
            updateStatus('‚úÖ Data refreshed successfully', 'online');
        }

        // ===========================================
        // ADMIN FUNCTIONS
        // ===========================================
        
        function showAdminLogin() {
            if (localStorage.getItem('adminLoggedIn') === 'true') {
                showMessage('adminPanel', true);
                updateAdminStats();
                return;
            }
            showMessage('adminSection', true);
            const passwordInput = document.getElementById('adminPassword');
            if (passwordInput) passwordInput.focus();
        }

        function loginAdmin() {
            const passwordInput = document.getElementById('adminPassword');
            if (!passwordInput) return;
            
            const password = passwordInput.value;
            if (password === ADMIN_PASSWORD) {
                localStorage.setItem('adminLoggedIn', 'true');
                showMessage('adminSection', false);
                showMessage('adminPanel', true);
                updateAdminStats();
                alert('‚úÖ Admin login successful!');
            } else {
                alert('‚ùå Incorrect admin password!');
            }
            passwordInput.value = '';
        }

        function logoutAdmin() {
            localStorage.removeItem('adminLoggedIn');
            showMessage('adminPanel', false);
            showMessage('adminSection', false);
            alert('üëã Admin logged out!');
        }

        function updateAdminStats() {
            const countEl = document.getElementById('signatureCount');
            const count = countEl ? parseInt(countEl.textContent) || 0 : 0;
            const progress = Math.round((count / TARGET_SIGNATURES) * 100);
            
            const statsEl = document.getElementById('adminStats');
            if (statsEl) {
                statsEl.innerHTML = 
                    `<strong>Firestore Database Statistics:</strong><br>` +
                    `Total Signatures: ${count}<br>` +
                    `Target: ${TARGET_SIGNATURES} (${progress}%)<br>` +
                    `Database: Firestore (Connected)<br>` +
                    `Collection: signatures<br>` +
                    `Last Updated: ${new Date().toLocaleTimeString()}`;
            }
        }

        async function testConnection() {
            try {
                console.log('üß™ Admin: Testing Firestore connection...');
                
                // Test by adding a temporary document
                const testRef = await addDoc(collection(db, '_connectionTest'), {
                    test: true,
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent.substring(0, 100)
                });
                
                console.log('‚úÖ Write test passed');
                
                // Test by reading the document
                const testQuery = query(collection(db, '_connectionTest'), limit(1));
                const testSnapshot = await getDocs(testQuery);
                
                console.log('‚úÖ Read test passed');
                
                // Clean up test document
                if (testRef.id) {
                    await deleteDoc(doc(db, '_connectionTest', testRef.id));
                    console.log('‚úÖ Delete test passed');
                }
                
                alert('‚úÖ FIRESTORE CONNECTION TEST: PASSED\n\n' +
                    'üåê Connection: Active\n' +
                    'üìñ Read Permission: OK\n' +
                    '‚úèÔ∏è Write Permission: OK\n' +
                    'üóëÔ∏è Delete Permission: OK\n\n' +
                    'Firestore database is fully functional!');
                
            } catch (error) {
                console.error('‚ùå Connection test failed:', error);
                alert(`‚ùå FIRESTORE CONNECTION TEST: FAILED\n\nError: ${error.message}\n\nCheck:\n‚Ä¢ Internet connection\n‚Ä¢ Firestore rules\n‚Ä¢ Project settings`);
            }
        }

        async function addTestData() {
            if (!isConnected) {
                alert('‚ùå Database not connected! Cannot add test data.');
                return;
            }
            
            const testSignature = {
                name: `Test User ${Date.now()}`,
                flat: `TEST-${Math.floor(Math.random() * 1000)}`,
                mobile: `555000${Math.floor(Math.random() * 10000)}`,
                concern: 'safety',
                timestamp: new Date().toISOString(),
                time: new Date().toLocaleString()
            };
            
            try {
                console.log('üß™ Adding test signature:', testSignature);
                
                const docRef = await addDoc(collection(db, 'signatures'), {
                    ...testSignature,
                    createdAt: serverTimestamp()
                });
                
                alert(`‚úÖ Test Signature Added Successfully!\n\n` +
                    `Document ID: ${docRef.id}\n` +
                    `Flat: ${testSignature.flat}\n` +
                    `Name: ${testSignature.name}\n\n` +
                    `The signature count will update automatically.`);
                
                // Refresh to show new signature
                await loadSignatures();
                
            } catch (error) {
                alert(`‚ùå Failed to Add Test Signature!\n\nError: ${error.message}`);
            }
        }

        function viewRules() {
            const message = `üîí Firestore Database Information\n\n` +
                `Current Firebase Project: ${firebaseConfig.projectId}\n` +
                `Database: Firestore\n` +
                `Collection: signatures\n\n` +
                `To manage your database:\n` +
                `1. Go to Firebase Console\n` +
                `2. Select your project: stray-dog-petition\n` +
                `3. Go to "Firestore Database"\n` +
                `4. View data in "signatures" collection\n\n` +
                `For rules, check the "Rules" tab in Firestore.`;
            
            alert(message);
        }

        async function viewAllSignatures() {
            if (!isConnected) {
                alert('‚ùå Database not connected! Cannot access signatures.');
                return;
            }
            
            try {
                const signaturesRef = collection(db, 'signatures');
                const q = query(signaturesRef, orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                
                let message = 'üëë ADMIN: All Signatures\n\n';
                let count = 0;
                
                querySnapshot.forEach((doc) => {
                    const sig = doc.data();
                    count++;
                    message += `${count}. ${sig.name}\n`;
                    message += `   Flat: ${sig.flat}\n`;
                    message += `   Mobile: ${sig.mobile}\n`;
                    message += `   Concern: ${sig.concern}\n`;
                    message += `   Signed: ${sig.time || sig.timestamp}\n`;
                    message += `   ID: ${doc.id}\n\n`;
                });
                
                if (count === 0) {
                    message += 'No signatures found in database.';
                }
                
                alert(message);
                
            } catch (error) {
                alert(`‚ùå Error accessing signatures: ${error.message}`);
            }
        }

        function exportData() {
            alert('üìä Firestore Export Options:\n\n' +
                '‚Ä¢ Go to Firebase Console\n' +
                '‚Ä¢ Firestore Database section\n' +
                '‚Ä¢ Export entire database or specific collections\n' +
                '‚Ä¢ Use Firebase CLI for advanced exports\n\n' +
                'Or view all signatures in admin panel and copy manually.');
        }

        async function resetAllData() {
            if (!isConnected) {
                alert('‚ùå Database not connected!');
                return;
            }
            
            if (confirm('‚ö†Ô∏è DANGER: Delete ALL signatures from Firestore?\n\n' +
                'This action cannot be undone!\n\n' +
                'Type "DELETE" in the next prompt to confirm.')) {
                
                const confirmation = prompt('Type "DELETE" to confirm database reset:');
                if (confirmation === 'DELETE') {
                    try {
                        const signaturesRef = collection(db, 'signatures');
                        const querySnapshot = await getDocs(signaturesRef);
                        
                        const deletePromises = [];
                        querySnapshot.forEach((document) => {
                            deletePromises.push(deleteDoc(doc(db, 'signatures', document.id)));
                        });
                        
                        await Promise.all(deletePromises);
                        
                        alert(`‚úÖ Database reset successfully! Deleted ${querySnapshot.size} signatures.`);
                        
                        // Refresh display
                        await loadSignatures();
                        
                    } catch (error) {
                        alert(`‚ùå Error resetting database: ${error.message}`);
                    }
                }
            }
        }

        // ===========================================
        // INITIALIZATION
        // ===========================================
        
        // Make functions global for onclick handlers
        window.shareOnWhatsApp = shareOnWhatsApp;
        window.refreshData = refreshData;
        window.showAdminLogin = showAdminLogin;
        window.loginAdmin = loginAdmin;
        window.logoutAdmin = logoutAdmin;
        window.testConnection = testConnection;
        window.addTestData = addTestData;
        window.viewRules = viewRules;
        window.viewAllSignatures = viewAllSignatures;
        window.exportData = exportData;
        window.resetAllData = resetAllData;

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üéØ DOM loaded, initializing application...');
            
            // Check if user already signed
            if (localStorage.getItem('hasSignedPetition') === 'true') {
                const signedFlat = localStorage.getItem('signedFlat');
                showMessage('errorMessage', true);
                showMessage('signatureForm', false);
                
                const errorEl = document.getElementById('errorMessage');
                if (errorEl && signedFlat) {
                    errorEl.innerHTML = `‚ö†Ô∏è You have already signed this petition from this device.<br>` +
                        `<small>Flat: ${signedFlat} ‚Ä¢ Your signature is safely stored in the database.</small>`;
                }
                
                console.log('üë§ User already signed from flat:', signedFlat);
            }
            
            // Setup form handler
            const form = document.getElementById('petitionForm');
            if (form) {
                form.addEventListener('submit', handleFormSubmit);
                console.log('üìù Form handler attached');
            }
            
            // Setup admin password enter key
            const passwordInput = document.getElementById('adminPassword');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loginAdmin();
                    }
                });
            }
            
            // Load existing signatures
            await loadSignatures();
            
            console.log('üéâ Application initialization complete');
        });
        
    </script>
</body>
</html>
